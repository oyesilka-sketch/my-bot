<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haber Detay - {{ haber.baslik }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .editable-field {
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fafafa;
            transition: all 0.3s ease;
        }
        .editable-field:hover {
            background-color: #f0f0f0;
        }
        .edit-mode {
            background-color: #fff !important;
            border-color: #007bff !important;
        }
        .edit-buttons {
            display: none;
        }
        .edit-buttons.active {
            display: inline-block;
        }
        .editor-container {
            height: 400px;
        }
        .word-count {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .status-badge {
            font-size: 12px;
        }
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- √úst Men√º -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <a href="/" class="btn btn-secondary">‚Üê Ana Sayfa</a>
                        <span class="badge bg-{{ 'success' if haber.durum == 'Yeni' else 'secondary' }} ms-2">{{ haber.durum }}</span>
                        <span class="badge bg-info ms-1">{{ haber.kaynak }}</span>
                    </div>
                    <div>
                        <button id="refreshBtn" class="btn btn-outline-primary">üîÑ Haberleri Yenile</button>
                    </div>
                </div>

                <!-- Ana ƒ∞√ßerik -->
                <div class="row">
                    <!-- Sol Panel - Haber Bilgileri -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5>Haber Detaylarƒ±</h5>
                            </div>
                            <div class="card-body">
                                <!-- D√ºzenlenebilir Ba≈ülƒ±k -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Haber Ba≈ülƒ±ƒüƒ±:</label>
                                    <div class="editable-field" id="baslikField" data-field="baslik">
                                        <div id="baslikDisplay">{{ haber.baslik }}</div>
                                        <input type="text" id="baslikInput" class="form-control d-none" value="{{ haber.baslik }}">
                                    </div>
                                    <div class="edit-buttons" id="baslikButtons">
                                        <button class="btn btn-sm btn-success" onclick="saveField('baslik')">Kaydet</button>
                                        <button class="btn btn-sm btn-secondary" onclick="cancelEdit('baslik')">ƒ∞ptal</button>
                                    </div>
                                </div>

                                <!-- D√ºzenlenebilir A√ßƒ±klama -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Haber A√ßƒ±klamasƒ±:</label>
                                    <div class="editable-field" id="aciklamaField" data-field="aciklama">
                                        <div id="aciklamaDisplay">{{ haber.description or "A√ßƒ±klama bulunamadƒ±" }}</div>
                                        <textarea id="aciklamaInput" class="form-control d-none" rows="3">{{ haber.description or "" }}</textarea>
                                    </div>
                                    <div class="edit-buttons" id="aciklamaButtons">
                                        <button class="btn btn-sm btn-success" onclick="saveField('aciklama')">Kaydet</button>
                                        <button class="btn btn-sm btn-secondary" onclick="cancelEdit('aciklama')">ƒ∞ptal</button>
                                    </div>
                                </div>

                                <!-- Orijinal Haber Metni -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Orijinal Haber Metni:</label>
                                    <div class="border p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                                        {{ haber.haber_metni or haber.content }}
                                    </div>
                                    <small class="text-muted">
                                        Kelime sayƒ±sƒ±: {{ haber.kelime_sayisi or (haber.haber_metni or haber.content or "").split()|length }}
                                        {% if haber.url %}
                                        | <a href="{{ haber.url }}" target="_blank">Kaynak Link</a>
                                        {% endif %}
                                    </small>
                                </div>

                                <!-- AI Yeniden Yazma -->
                                <div class="mb-3">
                                    <button id="aiRewriteBtn" class="btn btn-primary">ü§ñ AI ile Yeniden Yaz</button>
                                    <div id="aiProgress" class="d-none mt-2">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">
                                                AI i≈üliyor...
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- AI Edit√∂r -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">SEO Uyumlu ƒ∞√ßerik:</label>
                                    <div id="editor" class="editor-container"></div>
                                    <div class="word-count">
                                        <span id="wordCount">0</span> kelime
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Saƒü Panel - Yayƒ±n Ayarlarƒ± -->
                    <div class="col-md-4">
                        <!-- Kategori Se√ßimi -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>Kategori</h6>
                            </div>
                            <div class="card-body">
                                <select id="kategoriSelect" class="form-select">
                                    <option value="">Kategori se√ßin</option>
                                    {% for kategori in kategoriler %}
                                    <option value="{{ kategori.id }}">{{ kategori.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Etiketler -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>Etiketler</h6>
                            </div>
                            <div class="card-body">
                                <div id="tagsContainer" class="mb-2">
                                    <!-- Etiketler buraya eklenecek -->
                                </div>
                                <input type="text" id="tagInput" class="form-control form-control-sm" 
                                       placeholder="Etiket ekle ve Enter'a bas">
                            </div>
                        </div>

                        <!-- Kapak Fotoƒürafƒ± -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>Kapak Fotoƒürafƒ± <span class="text-danger">*</span></h6>
                            </div>
                            <div class="card-body">
                                <!-- Fotoƒüraf Y√ºkleme -->
                                <div class="mb-3">
                                    <input type="file" id="imageUpload" class="form-control" accept="image/*">
                                    <small class="text-muted">JPG, PNG, GIF formatlarƒ± kabul edilir (Max: 16MB)</small>
                                </div>
                                
                                <!-- Mevcut Fotoƒüraflar -->
                                <div class="mb-2">
                                    <label class="form-label">Mevcut Fotoƒüraflar:</label>
                                    <select id="imageSelect" class="form-select">
                                        <option value="">Fotoƒüraf se√ßin</option>
                                        {% for resim in resim_dosyalari %}
                                        <option value="{{ resim }}" 
                                                {% if haber.resim_dosyasi == resim %}selected{% endif %}>{{ resim }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <!-- Fotoƒüraf √ñnizlemesi -->
                                <div id="imagePreview" class="text-center">
                                    {% if haber.resim_dosyasi %}
                                    <img src="/static/images/{{ haber.resim_dosyasi }}" class="image-preview">
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Yayƒ±n Butonu -->
                        <div class="card">
                            <div class="card-body text-center">
                                <button id="publishBtn" class="btn btn-success btn-lg w-100" disabled>
                                    üì¢ WordPress'e Yayƒ±nla
                                </button>
                                <div id="publishProgress" class="d-none mt-2">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">
                                            Yayƒ±nlanƒ±yor...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Bildirimleri -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="successMessage"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
        <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="errorMessage"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        // Global deƒüi≈ükenler
        let quill;
        let currentTags = [];
        const haberId = '{{ haber.id }}';

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
            initializeEventListeners();
            updatePublishButton();
            initializeEditableFields();
        });

        // D√ºzenlenebilir alanlarƒ± ba≈ülat
        function initializeEditableFields() {
            // Ba≈ülƒ±k alanƒ±na tƒ±klama olayƒ±
            document.getElementById('baslikField').addEventListener('click', function() {
                startEdit('baslik');
            });

            // A√ßƒ±klama alanƒ±na tƒ±klama olayƒ±
            document.getElementById('aciklamaField').addEventListener('click', function() {
                startEdit('aciklama');
            });
        }

        // D√ºzenlemeyi ba≈ülat
        function startEdit(fieldName) {
            const field = document.getElementById(fieldName + 'Field');
            const display = document.getElementById(fieldName + 'Display');
            const input = document.getElementById(fieldName + 'Input');
            const buttons = document.getElementById(fieldName + 'Buttons');

            field.classList.add('edit-mode');
            display.classList.add('d-none');
            input.classList.remove('d-none');
            buttons.classList.add('active');
            input.focus();

            // Enter tu≈üu ile kaydetme
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && fieldName === 'baslik') {
                    saveField(fieldName);
                }
                if (e.key === 'Escape') {
                    cancelEdit(fieldName);
                }
            });
        }

        // Alan d√ºzenlemeyi iptal et
        function cancelEdit(fieldName) {
            const field = document.getElementById(fieldName + 'Field');
            const display = document.getElementById(fieldName + 'Display');
            const input = document.getElementById(fieldName + 'Input');
            const buttons = document.getElementById(fieldName + 'Buttons');

            field.classList.remove('edit-mode');
            display.classList.remove('d-none');
            input.classList.add('d-none');
            buttons.classList.remove('active');

            // Orijinal deƒüeri geri y√ºkle
            if (fieldName === 'baslik') {
                input.value = display.textContent;
            } else {
                input.value = display.textContent;
            }
        }

        // Alanƒ± kaydet
        function saveField(fieldName) {
            const input = document.getElementById(fieldName + 'Input');
            const newValue = input.value.trim();

            if (!newValue && fieldName === 'baslik') {
                showError('Ba≈ülƒ±k bo≈ü olamaz!');
                return;
            }

            // API'ye g√∂nder
            fetch('/api/haber-guncelle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    haber_id: haberId,
                    baslik: fieldName === 'baslik' ? newValue : undefined,
                    aciklama: fieldName === 'aciklama' ? newValue : undefined
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Display'i g√ºncelle
                    const display = document.getElementById(fieldName + 'Display');
                    display.textContent = newValue;
                    
                    // D√ºzenlemeyi sonlandƒ±r
                    cancelEdit(fieldName);
                    
                    showSuccess('Haber ba≈üarƒ±yla g√ºncellendi!');
                    
                    // Sayfa ba≈ülƒ±ƒüƒ±nƒ± da g√ºncelle (eƒüer ba≈ülƒ±k deƒüi≈ütiyse)
                    if (fieldName === 'baslik') {
                        document.title = 'Haber Detay - ' + newValue;
                    }
                } else {
                    showError(data.error || 'G√ºncelleme ba≈üarƒ±sƒ±z!');
                }
            })
            .catch(error => {
                showError('Bir hata olu≈ütu: ' + error.message);
            });
        }

        // Quill edit√∂r√ºn√º ba≈ülat
        function initializeEditor() {
            quill = new Quill('#editor', {
                theme: 'snow',
                placeholder: 'AI ile yeniden yazƒ±lmƒ±≈ü i√ßerik buraya gelecek...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        ['link'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });

            // Kelime sayƒ±sƒ±nƒ± g√ºncelle
            quill.on('text-change', updateWordCount);
        }

        // Event listenerlarƒ± ba≈ülat
        function initializeEventListeners() {
            // AI yeniden yazma
            document.getElementById('aiRewriteBtn').addEventListener('click', function() {
                rewriteWithAI();
            });

            // Haberleri yenile
            document.getElementById('refreshBtn').addEventListener('click', function() {
                refreshNews();
            });

            // Yayƒ±nla
            document.getElementById('publishBtn').addEventListener('click', function() {
                publishArticle();
            });

            // Etiket ekleme
            document.getElementById('tagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag(this.value.trim());
                    this.value = '';
                }
            });

            // Fotoƒüraf se√ßimi
            document.getElementById('imageSelect').addEventListener('change', function() {
                updateImagePreview(this.value);
                updatePublishButton();
            });

            // Fotoƒüraf y√ºkleme
            document.getElementById('imageUpload').addEventListener('change', function() {
                uploadImage(this.files[0]);
            });
        }

        // AI ile yeniden yaz
        function rewriteWithAI() {
            const btn = document.getElementById('aiRewriteBtn');
            const progress = document.getElementById('aiProgress');
            
            btn.disabled = true;
            progress.classList.remove('d-none');
            
            fetch('/api/ai-yeniden-yaz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    haber_id: haberId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    quill.root.innerHTML = data.icerik;
                    updateWordCount();
                    
                    // Etiketleri ekle
                    currentTags = [];
                    if (data.etiketler) {
                        data.etiketler.forEach(tag => addTag(tag));
                    }
                    
                    showSuccess('AI ile yeniden yazma tamamlandƒ±!');
                    updatePublishButton();
                } else {
                    showError(data.error || 'AI ile yeniden yazma ba≈üarƒ±sƒ±z!');
                }
            })
            .catch(error => {
                showError('Bir hata olu≈ütu: ' + error.message);
            })
            .finally(() => {
                btn.disabled = false;
                progress.classList.add('d-none');
            });
        }

        // Haberleri yenile
        function refreshNews() {
            const btn = document.getElementById('refreshBtn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '‚è≥ Yenileniyor...';
            btn.disabled = true;
            
            fetch('/api/haberleri-yenile', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(data.message);
                } else {
                    showError(data.error || 'Yenileme ba≈üarƒ±sƒ±z!');
                }
            })
            .catch(error => {
                showError('Bir hata olu≈ütu: ' + error.message);
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // Makaleyi yayƒ±nla
        function publishArticle() {
            const baslik = document.getElementById('baslikDisplay').textContent.trim();
            const icerik = quill.root.innerHTML;
            const kategori_id = document.getElementById('kategoriSelect').value;
            const resim_dosyasi = document.getElementById('imageSelect').value;
            
            if (!baslik) {
                showError('Ba≈ülƒ±k gerekli!');
                return;
            }
            
            if (!icerik || icerik.trim() === '<p><br></p>') {
                showError('ƒ∞√ßerik gerekli! √ñnce AI ile yeniden yazƒ±n.');
                return;
            }
            
            if (!resim_dosyasi) {
                showError('Kapak fotoƒürafƒ± se√ßmek zorunludur!');
                return;
            }
            
            const btn = document.getElementById('publishBtn');
            const progress = document.getElementById('publishProgress');
            
            btn.disabled = true;
            progress.classList.remove('d-none');
            
            fetch('/api/haberi-yayinla', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    baslik: baslik,
                    icerik: icerik,
                    etiketler: currentTags,
                    kategori_id: kategori_id || null,
                    resim_dosyasi: resim_dosyasi
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Haber ba≈üarƒ±yla yayƒ±nlandƒ±!');
                    if (data.link && data.link !== 'Link alƒ±namadƒ±') {
                        setTimeout(() => {
                            window.open(data.link, '_blank');
                        }, 1000);
                    }
                } else {
                    showError(data.error || 'Yayƒ±nlama ba≈üarƒ±sƒ±z!');
                }
            })
            .catch(error => {
                showError('Bir hata olu≈ütu: ' + error.message);
            })
            .finally(() => {
                btn.disabled = false;
                progress.classList.add('d-none');
                updatePublishButton();
            });
        }

        // Kelime sayƒ±sƒ±nƒ± g√ºncelle
        function updateWordCount() {
            const text = quill.getText().trim();
            const wordCount = text ? text.split(/\s+/).length : 0;
            document.getElementById('wordCount').textContent = wordCount;
        }

        // Etiket ekle
        function addTag(tagName) {
            if (!tagName || currentTags.includes(tagName)) return;
            
            currentTags.push(tagName);
            updateTagsDisplay();
        }

        // Etiket sil
        function removeTag(tagName) {
            currentTags = currentTags.filter(tag => tag !== tagName);
            updateTagsDisplay();
        }

        // Etiketleri g√∂r√ºnt√ºle
        function updateTagsDisplay() {
            const container = document.getElementById('tagsContainer');
            container.innerHTML = '';
            
            currentTags.forEach(tag => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary me-1 mb-1';
                badge.innerHTML = `${tag} <button type="button" class="btn-close btn-close-white" style="font-size: 8px;" onclick="removeTag('${tag}')"></button>`;
                container.appendChild(badge);
            });
        }

        // Fotoƒüraf √∂nizlemesini g√ºncelle
        function updateImagePreview(filename) {
            const preview = document.getElementById('imagePreview');
            if (filename) {
                preview.innerHTML = `<img src="/static/images/${filename}" class="image-preview">`;
            } else {
                preview.innerHTML = '';
            }
        }

        // Fotoƒüraf y√ºkle
        function uploadImage(file) {
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/fotograf-yukle', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Select'e yeni se√ßenek ekle
                    const select = document.getElementById('imageSelect');
                    const option = new Option(data.filename, data.filename);
                    select.add(option);
                    select.value = data.filename;
                    
                    // √ñnizlemeyi g√ºncelle
                    updateImagePreview(data.filename);
                    updatePublishButton();
                    
                    showSuccess('Fotoƒüraf ba≈üarƒ±yla y√ºklendi!');
                } else {
                    showError(data.error || 'Fotoƒüraf y√ºkleme ba≈üarƒ±sƒ±z!');
                }
            })
            .catch(error => {
                showError('Bir hata olu≈ütu: ' + error.message);
            });
        }

        // Yayƒ±n butonunu g√ºncelle
        function updatePublishButton() {
            const btn = document.getElementById('publishBtn');
            const hasImage = document.getElementById('imageSelect').value;
            const hasContent = quill && quill.getText().trim().length > 0;
            
            btn.disabled = !hasImage || !hasContent;
        }

        // Ba≈üarƒ± mesajƒ± g√∂ster
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();
        }

        // Hata mesajƒ± g√∂ster
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('errorToast'));
            toast.show();
        }
    </script>
</body>
</html>
