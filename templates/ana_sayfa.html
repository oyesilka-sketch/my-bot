<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haber Yönetim Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .haber-card {
            transition: transform 0.2s ease-in-out;
        }
        .haber-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 11px;
            padding: 4px 8px;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .link-input-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stats-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .truncate-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- Başlık ve İstatistikler -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="h2 mb-0">📰 Haber Yönetim Sistemi</h1>
                <p class="text-muted">Haberleri çekin, düzenleyin ve WordPress'e yayınlayın</p>
            </div>
            <div class="col-md-4">
                <div class="card stats-card border-0">
                    <div class="card-body p-3">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h4 mb-0">{{ toplam_haber }}</div>
                                <small>Toplam</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 mb-0 text-warning">{{ yeni_haber }}</div>
                                <small>Yeni</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 mb-0 text-info">{{ link_haber }}</div>
                                <small>Link</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Link'ten Haber Çekme Aracı -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card link-input-card border-0">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <div class="h2 mb-0">🔗</div>
                            </div>
                            <div class="col-md-8">
                                <div class="mb-2">
                                    <strong>Link'ten Haber Çek</strong>
                                </div>
                                <div class="input-group">
                                    <input type="url" id="linkInput" class="form-control" 
                                           placeholder="Haber linkini buraya yapıştırın (örn: https://www.sondakika.com/haber/...)">
                                    <button class="btn btn-light" type="button" id="linkFetchBtn">
                                        <span id="linkBtnText">📥 Haberi Çek</span>
                                    </button>
                                </div>
                                <small class="text-light">Sondakika.com ve diğer haber sitelerinden otomatik haber çekimi</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <button id="refreshAllBtn" class="btn btn-outline-light btn-sm w-100">
                                    🔄 Tüm Haberleri Yenile
                                </button>
                            </div>
                        </div>
                        <!-- Progress Bar -->
                        <div id="linkProgress" class="progress mt-3 d-none" style="height: 3px;">
                            <div class="progress-bar bg-light" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtre Seçenekleri -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-2">
                        <div class="d-flex align-items-center">
                            <span class="me-3"><strong>Filtrele:</strong></span>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="filtre" id="tumHaberler" 
                                       value="Tümü" {{ 'checked' if filtre == 'Tümü' else '' }}>
                                <label class="btn btn-outline-primary btn-sm" for="tumHaberler">
                                    Tümü ({{ toplam_haber }})
                                </label>

                                <input type="radio" class="btn-check" name="filtre" id="yeniHaberler" 
                                       value="Yeni" {{ 'checked' if filtre == 'Yeni' else '' }}>
                                <label class="btn btn-outline-success btn-sm" for="yeniHaberler">
                                    Yeni ({{ yeni_haber }})
                                </label>

                                <input type="radio" class="btn-check" name="filtre" id="istanbulHaberleri" 
                                       value="İstanbul" {{ 'checked' if filtre == 'İstanbul' else '' }}>
                                <label class="btn btn-outline-info btn-sm" for="istanbulHaberleri">
                                    İstanbul
                                </label>

                                <input type="radio" class="btn-check" name="filtre" id="guncelHaberler" 
                                       value="Güncel" {{ 'checked' if filtre == 'Güncel' else '' }}>
                                <label class="btn btn-outline-warning btn-sm" for="guncelHaberler">
                                    Güncel
                                </label>

                                <input type="radio" class="btn-check" name="filtre" id="linkHaberler" 
                                       value="Link" {{ 'checked' if filtre == 'Link' else '' }}>
                                <label class="btn btn-outline-secondary btn-sm" for="linkHaberler">
                                    Link ({{ link_haber }})
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Haber Listesi -->
        <div class="row">
            {% if haberler %}
                {% for haber in haberler %}
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                    <div class="card haber-card h-100">
                        <div class="card-header p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-{{ 'success' if haber.durum == 'Yeni' else 'secondary' }} status-badge">
                                        {{ haber.durum }}
                                    </span>
                                    <span class="badge bg-{{ 'info' if haber.kaynak == 'İstanbul' else 'warning' if haber.kaynak == 'Güncel' else 'dark' }} status-badge">
                                        {{ haber.kaynak }}
                                    </span>
                                </div>
                                <small class="text-muted">{{ haber.tarih[:16] if haber.tarih else '' }}</small>
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <h6 class="card-title truncate-3 mb-2" title="{{ haber.baslik or haber.headline }}">
                                {{ haber.baslik or haber.headline }}
                            </h6>
                            <p class="card-text text-muted small truncate-3">
                                {{ haber.description or (haber.haber_metni or haber.content or '')[:150] }}...
                            </p>
                            <div class="mt-auto">
                                <small class="text-muted">
                                    📊 {{ haber.kelime_sayisi or (haber.haber_metni or haber.content or "").split()|length }} kelime
                                    {% if haber.url %}
                                    | <a href="{{ haber.url }}" target="_blank" class="text-decoration-none">🔗 Kaynak</a>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="card-footer p-2">
                            <div class="d-grid">
                                <a href="/haber/{{ haber.id }}" class="btn btn-primary btn-sm">
                                    ✏️ Düzenle ve Yayınla
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <div class="h1 text-muted mb-3">📰</div>
                            <h4>Henüz haber bulunamadı</h4>
                            <p class="text-muted">Yukarıdaki link çekme aracını kullanarak haber ekleyebilir veya haberleri yenileyebilirsiniz.</p>
                            <button id="refreshEmptyBtn" class="btn btn-primary">🔄 Haberleri Yenile</button>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Toast Bildirimleri -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="successMessage"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
        <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="errorMessage"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
        });

        function initializeEventListeners() {
            // Link çekme
            document.getElementById('linkFetchBtn').addEventListener('click', function() {
                fetchNewsFromLink();
            });

            // Enter tuşu ile link çekme
            document.getElementById('linkInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    fetchNewsFromLink();
                }
            });

            // Tüm haberleri yenile
            document.getElementById('refreshAllBtn').addEventListener('click', function() {
                refreshAllNews();
            });

            // Boş sayfa yenileme butonu
            const refreshEmptyBtn = document.getElementById('refreshEmptyBtn');
            if (refreshEmptyBtn) {
                refreshEmptyBtn.addEventListener('click', function() {
                    refreshAllNews();
                });
            }

            // Filtre değişikliği
            document.querySelectorAll('input[name="filtre"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        applyFilter(this.value);
                    }
                });
            });
        }

        // Link'ten haber çek
        function fetchNewsFromLink() {
            const linkInput = document.getElementById('linkInput');
            const url = linkInput.value.trim();

            if (!url) {
                showError('Lütfen geçerli bir URL girin!');
                return;
            }

            if (!isValidUrl(url)) {
                showError('Lütfen geçerli bir URL formatı girin!');
                return;
            }

            const btn = document.getElementById('linkFetchBtn');
            const btnText = document.getElementById('linkBtnText');
            const progress = document.getElementById('linkProgress');

            // UI durumunu değiştir
            btn.disabled = true;
            btnText.textContent = '⏳ Çekiliyor...';
            progress.classList.remove('d-none');

            fetch('/api/link-haber-cek', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Haber başarıyla çekildi! Sayfa yenileniyor...');
                    linkInput.value = '';
                    
                    // 2 saniye sonra sayfayı yenile
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showError(data.error || 'Haber çekilemedi!');
                }
            })
            .catch(error => {
                showError('Bir hata oluştu: ' + error.message);
            })
            .finally(() => {
                btn.disabled = false;
                btnText.textContent = '📥 Haberi Çek';
                progress.classList.add('d-none');
            });
        }

        // Tüm haberleri yenile
        function refreshAllNews() {
            const btn = document.getElementById('refreshAllBtn') || document.getElementById('refreshEmptyBtn');
            const originalText = btn.innerHTML;

            btn.innerHTML = '⏳ Yenileniyor...';
            btn.disabled = true;

            fetch('/api/haberleri-yenile', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(data.message + ' Sayfa yenileniyor...');
                    
                    // 2 saniye sonra sayfayı yenile
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showError(data.error || 'Haberler yenilenemedi!');
                }
            })
            .catch(error => {
                showError('Bir hata oluştu: ' + error.message);
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // Filtre uygula
        function applyFilter(filterValue) {
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('filtre', filterValue);
            window.location.href = currentUrl.toString();
        }

        // URL doğrulama
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // Başarı mesajı göster
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();
        }

        // Hata mesajı göster
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('errorToast'));
            toast.show();
        }
    </script>
</body>
</html>
